<template><blockquote>
<p>这两天晚上帮学经济的同学从两个excel表中提取了些数据供他做数据分析。</p>
<p>第一次用python操作excel表，记录一下。</p>
<p>单纯读取写入excel数据不难，关键是对数据又进一步提取了有效值。</p>
</blockquote>
<p><a href="/scripts/lzs/%E8%B0%83%E7%A0%94%E6%95%B0%E6%8D%AE.xlsx" target="_blank" rel="noopener noreferrer">调研数据.xlsx<ExternalLinkIcon/></a></p>
<p><a href="/scripts/lzs/%E9%A2%84%E6%B5%8B%E4%BF%A1%E6%81%AF1.xlsx" target="_blank" rel="noopener noreferrer">预测信息1.xlsx<ExternalLinkIcon/></a></p>
<p><a href="/scripts/lzs/%E9%A2%84%E6%B5%8B%E4%BF%A1%E6%81%AF2.xlsx" target="_blank" rel="noopener noreferrer">预测信息2.xlsx<ExternalLinkIcon/></a></p>
<p><a href="/scripts/lzs/%E9%A2%84%E6%B5%8B%E4%BF%A1%E6%81%AF3.xlsx" target="_blank" rel="noopener noreferrer">预测信息3.xlsx<ExternalLinkIcon/></a></p>
<p><a href="/scripts/lzs/lzs.py" target="_blank" rel="noopener noreferrer">lzs.py<ExternalLinkIcon/></a></p>
<div class="language-python ext-py line-numbers-mode"><pre v-pre class="language-python"><code><span class="token keyword">from</span> functools <span class="token keyword">import</span> <span class="token builtin">reduce</span>
<span class="token keyword">from</span> logging<span class="token punctuation">.</span>config <span class="token keyword">import</span> valid_ident
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> allow_connection_pickling
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> time
<span class="token keyword">import</span> re
<span class="token keyword">import</span> copy


<span class="token keyword">def</span> <span class="token function">printList</span><span class="token punctuation">(</span>print_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
   count <span class="token operator">=</span> <span class="token number">1</span>   
   <span class="token keyword">for</span> result <span class="token keyword">in</span> print_list<span class="token punctuation">:</span>
       <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"     "</span><span class="token punctuation">,</span> count<span class="token punctuation">,</span> result<span class="token punctuation">)</span>
       count <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span>
<span class="token keyword">def</span> <span class="token function">deleteDuplicate</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span><span class="token punctuation">:</span>
   func <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> x <span class="token keyword">if</span> y <span class="token keyword">in</span> x <span class="token keyword">else</span> x <span class="token operator">+</span> <span class="token punctuation">[</span>y<span class="token punctuation">]</span>
   li <span class="token operator">=</span> <span class="token builtin">reduce</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">]</span> <span class="token operator">+</span> li<span class="token punctuation">)</span>
   <span class="token keyword">return</span> li

<span class="token keyword">def</span> <span class="token function">export_excel</span><span class="token punctuation">(</span>export<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
   <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"输出结果到《%s》..."</span><span class="token operator">%</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token comment">#将字典列表转换为DataFrame</span>
   pf <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>export<span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token comment">#指定字段顺序</span>
   order <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Stkcd'</span><span class="token punctuation">,</span><span class="token string">'Ananm'</span><span class="token punctuation">,</span><span class="token string">'InstitutionID'</span><span class="token punctuation">,</span><span class="token string">'Brokern'</span><span class="token punctuation">,</span><span class="token string">'YEAR'</span><span class="token punctuation">,</span><span class="token string">'count'</span><span class="token punctuation">]</span>
   pf <span class="token operator">=</span> pf<span class="token punctuation">[</span>order<span class="token punctuation">]</span>
   <span class="token comment">#将列名替换为中文</span>
   columns_map <span class="token operator">=</span> <span class="token punctuation">{</span>
       <span class="token string">'Stkcd'</span><span class="token punctuation">:</span><span class="token string">'Stkcd'</span><span class="token punctuation">,</span>
       <span class="token string">'Ananm'</span><span class="token punctuation">:</span><span class="token string">'Ananm'</span><span class="token punctuation">,</span>
       <span class="token string">'InstitutionID'</span><span class="token punctuation">:</span><span class="token string">'InstitutionID'</span><span class="token punctuation">,</span>
       <span class="token string">'Brokern'</span><span class="token punctuation">:</span><span class="token string">'Brokern'</span><span class="token punctuation">,</span>
       <span class="token string">'YEAR'</span><span class="token punctuation">:</span><span class="token string">'YEAR'</span><span class="token punctuation">,</span>
       <span class="token string">'count'</span><span class="token punctuation">:</span><span class="token string">'count'</span>
   <span class="token punctuation">}</span>
   pf<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>columns <span class="token operator">=</span> columns_map<span class="token punctuation">,</span>inplace <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
   <span class="token comment">#指定生成的Excel表格名称</span>
   file_path <span class="token operator">=</span> pd<span class="token punctuation">.</span>ExcelWriter<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>
   <span class="token comment">#替换空单元格</span>
   pf<span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span>inplace <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
   <span class="token comment">#输出</span>
   pf<span class="token punctuation">.</span>to_excel<span class="token punctuation">(</span>file_path<span class="token punctuation">,</span>encoding <span class="token operator">=</span> <span class="token string">'utf-8'</span><span class="token punctuation">,</span>index <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
   <span class="token comment">#保存表格</span>
   file_path<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"输出结果成功"</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>
   <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"读取《调研数据.xlsx》..."</span><span class="token punctuation">)</span>
   all_start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
   df0 <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_excel<span class="token punctuation">(</span><span class="token string">'调研数据.xlsx'</span><span class="token punctuation">)</span>
   <span class="token comment"># print(df0)</span>
   all_list <span class="token operator">=</span> df0<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span>orient<span class="token operator">=</span><span class="token string">'records'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">]</span>
   result_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
   <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>all_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
       <span class="token builtin">all</span> <span class="token operator">=</span> all_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
       researcher_list <span class="token operator">=</span> <span class="token builtin">all</span><span class="token punctuation">[</span><span class="token string">'Researcher'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span>
       <span class="token keyword">for</span> researcher <span class="token keyword">in</span> researcher_list<span class="token punctuation">:</span>
           semicolon_index <span class="token operator">=</span> researcher<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>
           <span class="token keyword">if</span> semicolon_index <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
               researcher <span class="token operator">=</span> researcher<span class="token punctuation">[</span>semicolon_index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
               researchers <span class="token operator">=</span> researcher<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"、"</span><span class="token punctuation">)</span>
               
               <span class="token keyword">for</span> research <span class="token keyword">in</span> researchers<span class="token punctuation">:</span>
                   all_copy <span class="token operator">=</span> <span class="token builtin">all</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
                   all_copy<span class="token punctuation">[</span><span class="token string">'Researcher'</span><span class="token punctuation">]</span> <span class="token operator">=</span> research<span class="token punctuation">;</span>
                   result_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_copy<span class="token punctuation">)</span>
                   <span class="token comment"># print(len(result_list), research, result_list[len(result_list)-1])</span>
           <span class="token keyword">else</span> <span class="token punctuation">:</span>
               all_copy <span class="token operator">=</span> <span class="token builtin">all</span><span class="token punctuation">;</span>
               all_copy<span class="token punctuation">[</span><span class="token string">'Researcher'</span><span class="token punctuation">]</span> <span class="token operator">=</span> researcher<span class="token punctuation">;</span>
               result_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_copy<span class="token punctuation">)</span>
               <span class="token comment"># print(len(result_list), researcher, result_list[len(result_list)-1])</span>
   <span class="token comment"># printList(result_list)</span>
   <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"读取《调研数据初始化》共[%d]条数据"</span> <span class="token operator">%</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>result_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

   file_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
   file_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'预测信息1.xlsx'</span><span class="token punctuation">)</span>
   file_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'预测信息2.xlsx'</span><span class="token punctuation">)</span>
   file_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'预测信息3.xlsx'</span><span class="token punctuation">)</span>
   <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> file_list<span class="token punctuation">:</span>
       start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"读取《%s》..."</span> <span class="token operator">%</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       df0 <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_excel<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span>
       <span class="token comment"># print(df1)</span>
       data_list <span class="token operator">=</span> df0<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span>orient<span class="token operator">=</span><span class="token string">'records'</span><span class="token punctuation">)</span>
       <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"读取《%s》共[%d]条数据，开始统计..."</span> <span class="token operator">%</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

       count <span class="token operator">=</span> <span class="token number">0</span>
       <span class="token keyword">for</span> data <span class="token keyword">in</span> data_list<span class="token punctuation">:</span>
           data<span class="token punctuation">[</span><span class="token string">'count'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
           <span class="token comment"># print(count / len(data_list))</span>
           count <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span>
           <span class="token keyword">for</span> result <span class="token keyword">in</span> result_list<span class="token punctuation">:</span>
               <span class="token keyword">if</span> result<span class="token punctuation">[</span><span class="token string">'Researcher'</span><span class="token punctuation">]</span> <span class="token keyword">in</span> <span class="token builtin">str</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'Ananm'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                   data<span class="token punctuation">[</span><span class="token string">'count'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'count'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
       export_excel<span class="token punctuation">(</span>data_list<span class="token punctuation">,</span> <span class="token string">"result_%s"</span><span class="token operator">%</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

       valid_count <span class="token operator">=</span> <span class="token number">0</span>
       <span class="token keyword">for</span> data <span class="token keyword">in</span> data_list<span class="token punctuation">:</span>
           <span class="token keyword">if</span> data<span class="token punctuation">[</span><span class="token string">'count'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
               valid_count <span class="token operator">=</span> valid_count <span class="token operator">+</span> <span class="token number">1</span>
               <span class="token comment"># if (valid_count &lt; 100) :</span>
               <span class="token comment">#     print(data)</span>
                   <span class="token comment"># print (data['Stkcd'], data['Ananm'], data['Brokern'], data['InstitutionID'], data['YEAR'], data['count'])</span>
       <span class="token keyword">print</span><span class="token punctuation">(</span> <span class="token string">"有效数据(count > 0)[%d]条，耗时[%.3fs]"</span><span class="token operator">%</span><span class="token punctuation">(</span>valid_count<span class="token punctuation">,</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"总耗时[%d]s"</span><span class="token operator">%</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> all_start<span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br></div></div></template>
